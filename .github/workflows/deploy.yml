name: Deploy (web + worker + DNS)
on:
  push: { branches: [ main ] }
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CF_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: npm ci || npm i

      - name: Build site
        run: npm run build

      - name: Deploy Worker (${{ matrix.environment }})
        run: npx wrangler deploy --config wrangler.worker.toml --env=${{ matrix.environment }} --minify

      - name: Deploy Worker (prod)
        run: npx wrangler deploy --env=production

      - name: Sync DNS
        run: bash infra/scripts/upsert-goldshore-dns.sh
