name: AI maintenance (safe)

on:
  schedule: [{ cron: "0 5 * * *" }]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_PROJECT_ID: ${{ secrets.OPENAI_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Install node
        uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install tooling
        run: |
          npm i -D stylelint stylelint-config-standard htmlhint eslint lighthouse @actions/core @actions/github

      - name: Lint CSS/HTML/JS
        run: |
          npx stylelint "apps/web/src/**/*.css"
          npx htmlhint "apps/web/src/**/*.astro" || true
          npx eslint "apps/web/src/**/*.{js,ts,astro}" || true

      - name: CSS Guardrails (block binaries/huge files)
        run: |
          bad=$(find apps/web -name "*.css" -size +500k -print -o -type f -name "*.css" -exec file -bi {} \; | grep -v "text/")
          if [ -n "$bad" ]; then echo "âŒ Bad CSS detected"; echo "$bad"; exit 1; fi

      - name: Build site (Astro)
        working-directory: apps/web
        run: |
          npm i astro@latest --no-save
          npx astro build

      - name: Lighthouse smoke (static)
        run: |
          npm i -g http-server
          http-server apps/web/dist -p 4173 & sleep 2
          npx lighthouse http://localhost:4173 --only-categories=performance,accessibility,best-practices,seo --output=json --output-path=./lh.json --quiet
          score=$(jq '[.categories.performance.score,.categories.accessibility.score,.categories.seo.score] | add/3' lh.json)
          echo "Average score: $score"
          awk 'BEGIN {exit !( '"$score"' >= 0.85 )}'

      - name: AI copy/link suggestions (PR only)
        run: |
          node - <<'JS'
          const fs=require('fs');
          const { execSync } = require('child_process');
          const files = ['apps/web/src/pages/index.astro'];
          let patch = '';
          for (const f of files) {
            const original = fs.readFileSync(f,'utf-8');
            let updated = original.replace(/we steer markets, not money/gi, 'We build market tools that respect capital and context.');
            if (updated !== original) {
              fs.writeFileSync(f, updated);
              patch += `\n[MODIFIED] ${f}`;
            }
          }
          if (!patch) { console.log('No edits.'); process.exit(0); }
          execSync('git config user.email "bot@goldshore.org"');
          execSync('git config user.name "goldshore-ai"');
          execSync('git checkout -b chore/ai-maint');
          execSync('git add -A');
          execSync('git commit -m "AI: copy polish + link graph refresh"');
          execSync('git push -u origin chore/ai-maint');
          console.log('PR branch pushed.');
          JS
